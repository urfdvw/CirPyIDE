<!DOCTYPE html>
<html>

<head>

    <head>
        <style>
            body{
                color: rgb(248, 248, 242);
                background-color:rgb(39, 40, 34);
            }

            .row {
                display: flex;
            }

            .column {
                flex: 50%;
            }

            .head {
                height: 50px;
            }

            .toolbar {
                height: 20px;
            }

            .content {
                height: calc(100vh - 20px - 50px - 40px - 20px);
                overflow-y: scroll;
                border: 1px solid grey;
            }

            .tail {
                height: 20px;
            }
        </style>
    </head>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css">
    </link>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/theme/monokai.min.css">
    </link>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js">
    </script>

    <script type="text/javascript" src="https://codemirror.net/mode/python/python.js">
    </script>

    <script>
        var port
        async function connect_serial() {
            port = await navigator.serial.requestPort();
            await port.open({
                baudRate: 115200,
                dataBits: 8,
                stopBits: 1,

            });
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();

            // Listen to data coming from the serial device.
            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    // Allow the serial port to be closed later.
                    reader.releaseLock();
                    break;
                }
                // value is a string.
                console.log(value);
                document.getElementById('serial_out').innerHTML += value
            }
        }

        function save_and_run() {
            document.getElementById('serial_out').innerHTML = '';
            writeFile(fileHandle, editor.getValue());
        }
    </script>
</head>

<body >
    <div class="head">
        <h1>CircuitPython Online Editor</h1>
    </div>

    <div class="row">
        <div class="column toolbar">
            Editor
            <button id="inputfile"> Open </button>
            <button onClick='save_and_run()'> Save and Run </button>
        </div>
        <div class="column toolbar">
            Serial
            <button onClick='connect_serial()'> Connect </button>
            <button onClick="document.getElementById('serial_out').innerHTML = ''"> Clear </button>
        <button onclick="window.open('help.html')" style="float: right;">
            IDE Help
        </button>
        </div>
    </div>
    <div class="row">
        <div class="column content">
            <div id="my-div">
            </div>
        </div>
        <div class="column content">
            <pre id="serial_out">
            </pre>
        </div>
    </div>
    
    <div class="row tail">
        CircuitPython API Reference:
        <button onclick="window.open('https://circuitpython.readthedocs.io/en/latest/shared-bindings/index.html#')">
            Core Modules
        </button>
        <button onclick="window.open('https://circuitpython.readthedocs.io/projects/bundle/en/latest/drivers.html#')">
            Sponsored Libraries and Drivers
        </button>
        <button onclick="window.open('https://circuitpython.readthedocs.io/en/latest/docs/library/index.html#')">
            MicroPython libraries
        </button>
        <button onclick="window.open('https://circuitpython.org/')">
            CircuitPython Homepage
        </button>
    </div>

    <script type="text/javascript">

        var editor = CodeMirror(document.querySelector('#my-div'), {
            lineNumbers: true,
            value: 'print("Hello, World!")',
            tabSize: 4,
            indentUnit: 4,
            mode: 'python',
            theme: 'monokai',
            extraKeys: { Tab: betterTab },
        });
        editor.setSize(width = '100%', height = '100%')

        let fileHandle;
        var butOpenFile = document.getElementById("inputfile")
        butOpenFile.addEventListener('click', async () => {
            [fileHandle] = await window.showOpenFilePicker();
            const file = await fileHandle.getFile();
            const contents = await file.text();
            editor.setValue(contents);
        });

        async function writeFile(fileHandle, contents) {
            // Create a FileSystemWritableFileStream to write to.
            const writable = await fileHandle.createWritable();
            // Write the contents of the file to the stream.
            await writable.write(contents);
            // Close the file and write the contents to disk.
            await writable.close();
        }

        document.getElementById('inputfile')
            // https://www.geeksforgeeks.org/how-to-read-a-local-text-file-using-javascript/
            .addEventListener('change', function () {
                var fr = new FileReader();
                fr.onload = function () {
                    // console.log(fr.result);
                    editor.setValue(fr.result);
                }
                fr.readAsText(this.files[0]);
            })

        function betterTab(cm) {
            // https://github.com/codemirror/CodeMirror/issues/988#issuecomment-14921785
            if (cm.somethingSelected()) {
                cm.indentSelection("add");
            } else {
                cm.replaceSelection(cm.getOption("indentWithTabs") ? "\t" :
                    Array(cm.getOption("tabSize") + 1).join(" "), "end", "+input");
            }
        }

        // Function to download data to a file
        function download(data, filename, type) {
            var file = new Blob([data], { type: type });
            if (window.navigator.msSaveOrOpenBlob) // IE10+
                window.navigator.msSaveOrOpenBlob(file, filename);
            else { // Others
                var a = document.createElement("a"),
                    url = URL.createObjectURL(file);
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(function () {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }
        }

    </script>
</body>

</html>